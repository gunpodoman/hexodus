<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>HEXODUS: CANNON</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { margin: 0; background: #0f172a; color: white; font-family: sans-serif; overflow: hidden; }
        #lobby { position: fixed; inset: 0; background: #020617; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; }
        #game-ui { position: absolute; top: 20px; width: 100%; display: none; justify-content: space-between; padding: 0 40px; box-sizing: border-box; }
        .hud { background: rgba(0,0,0,0.8); padding: 15px; border-radius: 10px; border: 1px solid #334155; }
        #controls { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); display: none; background: rgba(0,0,0,0.8); padding: 20px; border-radius: 15px; gap: 20px; align-items: center; border: 1px solid #3b82f6; }
        input[type=range] { width: 150px; }
        .btn { background: #3b82f6; color: white; border: none; padding: 15px 30px; cursor: pointer; border-radius: 8px; font-weight: bold; }
        .btn:disabled { background: #1e293b; color: #64748b; cursor: not-allowed; }
        canvas { display: block; background: linear-gradient(to bottom, #1e293b, #0f172a); }
        #turn-indicator { position: absolute; top: 100px; left: 50%; transform: translateX(-50%); font-size: 2rem; font-weight: bold; color: #fbbf24; text-shadow: 0 0 10px rgba(0,0,0,0.5); }
    </style>
</head>
<body>

<div id="lobby">
    <h1 style="font-size: 3rem; margin-bottom: 20px;">HEXODUS CANNON</h1>
    <button class="btn" onclick="quickMatch()">전투 시작 (매칭)</button>
    <p id="lobby-status" style="margin-top: 20px; color: #94a3b8;"></p>
</div>

<div id="game-ui">
    <div class="hud" style="border-left: 4px solid #3b82f6;">
        <div id="p1-label">PLAYER 1 (BLUE)</div>
        <div id="p1-hp" style="font-size: 1.5rem; color: #60a5fa;">HP: 100</div>
    </div>
    <div id="turn-indicator">대기 중...</div>
    <div class="hud" style="text-align: right; border-right: 4px solid #ef4444;">
        <div id="p2-label">PLAYER 2 (RED)</div>
        <div id="p2-hp" style="font-size: 1.5rem; color: #f87171;">HP: 100</div>
    </div>
</div>

<div id="controls">
    <div>각도: <span id="angle-val">45</span>°<br><input type="range" id="angle-input" min="0" max="180" value="45"></div>
    <div>파워: <span id="power-val">50</span><br><input type="range" id="power-input" min="10" max="100" value="50"></div>
    <button id="fire-btn" class="btn" onclick="fire()">FIRE!</button>
</div>

<canvas id="gameCanvas"></canvas>

<script>
    const SUPABASE_URL = 'https://ypwfazsbnudddksqkkiz.supabase.co/';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlwd2ZhenNibnVkZGRrc3Fra2l6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY5ODg4NTgsImV4cCI6MjA4MjU2NDg1OH0.Mz0jdNuLughgNtklbuBeh5K2Q4HQf2cKt6dmeqBSJy4';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let myId = "U_" + Math.random().toString(36).substr(2, 4);
    let roomId, mySide, currentTurn;
    let p1Hp = 100, p2Hp = 100;
    let projectiles = [];

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    // UI 동기화
    document.getElementById('angle-input').oninput = e => document.getElementById('angle-val').innerText = e.target.value;
    document.getElementById('power-input').oninput = e => document.getElementById('power-val').innerText = e.target.value;

    async function quickMatch() {
        document.getElementById('lobby-status').innerText = "매칭 중...";
        const { data: rooms } = await supabase.from('cannon_rooms').select('*').eq('status', 'WAITING').limit(1);

        if (rooms && rooms.length > 0) {
            roomId = rooms[0].id;
            mySide = 'right';
            await supabase.from('cannon_rooms').update({ p2_id: myId, status: 'PLAYING' }).eq('id', roomId);
            initGame();
        } else {
            const { data } = await supabase.from('cannon_rooms').insert([{ p1_id: myId, status: 'WAITING' }]).select().single();
            roomId = data.id;
            mySide = 'left';
            document.getElementById('lobby-status').innerText = "상대방을 기다리고 있습니다...";
            supabase.channel(`room_${roomId}`).on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'cannon_rooms' }, (p) => {
                if (p.new.status === 'PLAYING') initGame();
            }).subscribe();
        }
    }

    function initGame() {
        document.getElementById('lobby').style.display = 'none';
        document.getElementById('game-ui').style.display = 'flex';
        document.getElementById('controls').style.display = 'flex';
        resize();

        // 발사 정보 구독
        supabase.channel(`shots_${roomId}`).on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'cannon_actions' }, (p) => {
            if (p.new.room_id === roomId) createProjectile(p.new.side, p.new.angle, p.new.power);
        }).subscribe();

        // 턴 및 체력 동기화 구독
        supabase.channel(`sync_${roomId}`).on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'cannon_rooms' }, (p) => {
            currentTurn = p.new.turn;
            p1Hp = p.new.p1_hp;
            p2Hp = p.new.p2_hp;
            updateUI();
        }).subscribe();

        currentTurn = 'left';
        updateUI();
        requestAnimationFrame(render);
    }

    async function fire() {
        if (currentTurn !== mySide) return;
        const angle = document.getElementById('angle-input').value;
        const power = document.getElementById('power-input').value;

        // 1. 발사 정보 전송
        await supabase.from('cannon_actions').insert([{ room_id: roomId, side: mySide, angle: parseFloat(angle), power: parseFloat(power) }]);
        
        // 2. 턴 교체 (방장만 업데이트하거나 각자 처리)
        const nextTurn = mySide === 'left' ? 'right' : 'left';
        await supabase.from('cannon_rooms').update({ turn: nextTurn }).eq('id', roomId);
    }

    function createProjectile(side, angle, power) {
        const rad = angle * (Math.PI / 180);
        const startX = side === 'left' ? 100 : canvas.width - 100;
        const startY = canvas.height - 100;
        
        projectiles.push({
            side,
            x: startX, y: startY,
            vx: Math.cos(rad) * (power / 5) * (side === 'left' ? 1 : -1),
            vy: -Math.sin(rad) * (power / 5),
            active: true
        });
    }

    function render() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // 지면
        ctx.fillStyle = '#334155'; ctx.fillRect(0, canvas.height - 50, canvas.width, 50);

        // 캐논(포탑)
        drawCannon(100, canvas.height - 50, '#3b82f6');
        drawCannon(canvas.width - 100, canvas.height - 50, '#ef4444');

        // 포탄 업데이트
        projectiles.forEach((p, i) => {
            if (!p.active) return;
            p.x += p.vx;
            p.vy += 0.2; // 중력
            p.y += p.vy;

            ctx.fillStyle = 'white';
            ctx.beginPath(); ctx.arc(p.x, p.y, 5, 0, Math.PI*2); ctx.fill();

            // 충돌 체크
            if (p.y > canvas.height - 50) {
                checkHit(p);
                p.active = false;
            }
        });

        requestAnimationFrame(render);
    }

    async function checkHit(p) {
        const targetX = p.side === 'left' ? canvas.width - 100 : 100;
        const dist = Math.abs(p.x - targetX);
        
        if (dist < 40 && mySide === 'left') { // 판정은 한 쪽에서만 수행 (동기화)
            if (p.side === 'left') {
                await supabase.from('cannon_rooms').update({ p2_hp: Math.max(0, p2Hp - 20) }).eq('id', roomId);
            } else {
                await supabase.from('cannon_rooms').update({ p1_hp: Math.max(0, p1Hp - 20) }).eq('id', roomId);
            }
        }
    }

    function drawCannon(x, y, color) {
        ctx.fillStyle = color;
        ctx.fillRect(x - 20, y - 30, 40, 30);
        ctx.fillRect(x - 5, y - 50, 10, 20);
    }

    function updateUI() {
        document.getElementById('p1-hp').innerText = `HP: ${p1Hp}`;
        document.getElementById('p2-hp').innerText = `HP: ${p2Hp}`;
        document.getElementById('turn-indicator').innerText = (currentTurn === mySide) ? "YOUR TURN!" : "WAITING...";
        document.getElementById('fire-btn').disabled = (currentTurn !== mySide);

        if (p1Hp <= 0 || p2Hp <= 0) {
            alert(p1Hp <= 0 ? "RED TEAM WIN!" : "BLUE TEAM WIN!");
            location.reload();
        }
    }

    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.onresize = resize;
    quickMatch();
</script>
</body>
</html>
