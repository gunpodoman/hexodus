<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>HEXODUS: UNIT BATTLE</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --left-color: #3b82f6; --right-color: #ef4444; --bg: #0f172a; }
        body { margin: 0; background: var(--bg); color: white; font-family: 'Pretendard', sans-serif; overflow: hidden; }
        
        /* ë¡œë¹„ ë° í™”ë©´ ë®ê°œ */
        #lobby, #overlay { position: fixed; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; background: var(--bg); z-index: 100; }
        .room-card { background: #1e293b; padding: 20px; margin: 10px; width: 350px; border-radius: 12px; border: 1px solid #334155; display: flex; justify-content: space-between; align-items: center; }
        
        /* ê²Œì„ ì¸í„°í˜ì´ìŠ¤ */
        #game-ui { position: absolute; top: 0; left: 0; right: 0; padding: 20px; display: none; justify-content: space-between; pointer-events: none; }
        .hud { background: rgba(0,0,0,0.6); padding: 15px; border-radius: 10px; pointer-events: auto; min-width: 150px; border: 2px solid #333; }
        
        /* í•˜ë‹¨ ìœ ë‹› ìƒì‚° ë²„íŠ¼ */
        #controls { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); display: none; gap: 15px; pointer-events: auto; }
        .unit-btn { background: #1e293b; border: 2px solid #475569; color: white; padding: 15px 25px; cursor: pointer; border-radius: 10px; text-align: center; transition: 0.2s; }
        .unit-btn:hover { background: #334155; transform: translateY(-5px); }
        .unit-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .price { display: block; font-size: 0.8em; color: #fbbf24; margin-top: 5px; }

        canvas { display: block; background: linear-gradient(to bottom, #1e293b, #0f172a); }
    </style>
</head>
<body>

<div id="lobby">
    <h1 style="font-size: 3rem; margin-bottom: 10px;">HEXODUS</h1>
    <p style="color: #94a3b8; margin-bottom: 30px;">ì‹¤ì‹œê°„ 1vs1 ìœ ë‹› ëŒ€ì „</p>
    <button class="unit-btn" onclick="createRoom()" style="background: var(--left-color); border: none;">+ ìƒˆ ê²½ê¸° ìƒì„±</button>
    <div id="room-list" style="margin-top: 20px;"></div>
</div>

<div id="game-ui">
    <div class="hud" style="border-left: 5px solid var(--left-color);">
        <div id="p-left-name">ëŒ€ê¸° ì¤‘...</div>
        <div style="font-size: 1.5rem; color: #fbbf24;"><span id="gold">0</span>G</div>
    </div>
    <div style="text-align: center; flex-grow: 1; padding-top: 20px;">
        <h2 id="match-status" style="letter-spacing: 5px; color: #64748b;">VS</h2>
    </div>
    <div class="hud" style="text-align: right; border-right: 5px solid var(--right-color);">
        <div id="p-right-name">ëŒ€ê¸° ì¤‘...</div>
        <div style="color: #94a3b8;">CORE HP</div>
        <div id="core-hp" style="font-size: 1.5rem; color: #ff4757;">100 / 100</div>
    </div>
</div>

<div id="controls">
    <button class="unit-btn" onclick="spawnUnit('sword')">âš”ï¸ ê²€ë³‘ <span class="price">20G</span></button>
    <button class="unit-btn" onclick="spawnUnit('shield')">ğŸ›¡ï¸ ë°©íŒ¨ë³‘ <span class="price">50G</span></button>
    <button class="unit-btn" onclick="spawnUnit('archer')">ğŸ¹ ê¶ìˆ˜ <span class="price">40G</span></button>
</div>

<div id="overlay" style="display: none;">
    <h1 id="result-text">WINNER</h1>
    <button class="unit-btn" onclick="location.reload()">ë¡œë¹„ë¡œ ëŒì•„ê°€ê¸°</button>
</div>

<canvas id="gameCanvas"></canvas>

<script>
    const SUPABASE_URL = 'https://ypwfazsbnudddksqkkiz.supabase.co/';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlwd2ZhenNibnVkZGRrc3Fra2l6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY5ODg4NTgsImV4cCI6MjA4MjU2NDg1OH0.Mz0jdNuLughgNtklbuBeh5K2Q4HQf2cKt6dmeqBSJy4';
    const sClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let myId, currentRoomId, mySide; 
    let gold = 0;
    let baseHp = { left: 100, right: 100 };
    let units = []; // {side, type, x, y, hp, maxHp, speed, range, damage}
    
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    const UNIT_TYPES = {
        sword:  { hp: 100, speed: 1.5, range: 40, damage: 10, cost: 20, icon: 'âš”ï¸' },
        shield: { hp: 300, speed: 0.8, range: 35, damage: 5,  cost: 50, icon: 'ğŸ›¡ï¸' },
        archer: { hp: 60,  speed: 1.2, range: 200, damage: 15, cost: 40, icon: 'ğŸ¹' }
    };

    async function init() {
        const { data: { user } } = await sClient.auth.signInAnonymously();
        myId = user.id;
        refreshRooms();
        sClient.channel('lobby').on('postgres_changes', { event: '*', schema: 'public', table: 'rooms' }, refreshRooms).subscribe();
    }

    async function refreshRooms() {
        const { data } = await sClient.from('rooms').select('*').eq('status', 'waiting');
        const list = document.getElementById('room-list');
        list.innerHTML = '';
        data.forEach(room => {
            list.innerHTML += `<div class="room-card"><span>${room.name}</span><button class="unit-btn" onclick="joinRoom('${room.id}')" style="padding: 10px 20px;">ì°¸ê°€</button></div>`;
        });
    }

    async function createRoom() {
        const { data } = await sClient.from('rooms').insert([{ name: 'ì „íˆ¬ ë°©', player_left: myId }]).select().single();
        mySide = 'left';
        currentRoomId = data.id;
        waitForPlayer();
    }

    async function joinRoom(roomId) {
        mySide = 'right';
        currentRoomId = roomId;
        await sClient.from('rooms').update({ player_right: myId, status: 'playing' }).eq('id', roomId);
        startBattle();
    }

    function waitForPlayer() {
        document.getElementById('lobby').innerHTML = `<h1>í”Œë ˆì´ì–´ ëŒ€ê¸° ì¤‘...</h1><p>ìƒëŒ€ë°©ì´ ë“¤ì–´ì˜¤ë©´ ì‹œì‘ë©ë‹ˆë‹¤.</p>`;
        sClient.channel(`room_${currentRoomId}`).on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'rooms' }, payload => {
            if (payload.new.status === 'playing') startBattle();
        }).subscribe();
    }

    function startBattle() {
        document.getElementById('lobby').style.display = 'none';
        document.getElementById('game-ui').style.display = 'flex';
        document.getElementById('controls').style.display = 'flex';
        
        // ì‹¤ì‹œê°„ ì•¡ì…˜ êµ¬ë…
        sClient.channel(`actions_${currentRoomId}`)
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'game_actions', filter: `room_id=eq.${currentRoomId}` }, payload => {
                createUnit(payload.new.player_side, payload.new.unit_type);
            }).subscribe();

        // ê³¨ë“œ ì¶©ì „ (1ì´ˆì— 10G)
        setInterval(() => { gold += 10; updateUI(); }, 1000);
        
        resize();
        gameLoop();
    }

    async function spawnUnit(type) {
        if (gold < UNIT_TYPES[type].cost) return;
        gold -= UNIT_TYPES[type].cost;
        updateUI();
        await sClient.from('game_actions').insert([{ room_id: currentRoomId, player_side: mySide, unit_type: type }]);
    }

    function createUnit(side, type) {
        const stats = UNIT_TYPES[type];
        units.push({
            side, type,
            x: side === 'left' ? 100 : canvas.width - 100,
            y: canvas.height / 2 + (Math.random() * 60 - 30),
            hp: stats.hp,
            maxHp: stats.hp,
            speed: stats.speed,
            range: stats.range,
            damage: stats.damage,
            icon: stats.icon
        });
    }

    function gameLoop() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // ì„± ê·¸ë¦¬ê¸°
        drawBase(50, canvas.height / 2, 'left', baseHp.left);
        drawBase(canvas.width - 50, canvas.height / 2, 'right', baseHp.right);

        // ìœ ë‹› ì—…ë°ì´íŠ¸
        units.forEach((u, i) => {
            let targetSide = u.side === 'left' ? 'right' : 'left';
            let enemyBaseX = u.side === 'left' ? canvas.width - 50 : 50;
            
            // 1. ì  ìœ ë‹› ì°¾ê¸°
            let closestEnemy = null;
            let minDist = Infinity;
            units.forEach(target => {
                if (target.side !== u.side) {
                    let d = Math.abs(u.x - target.x);
                    if (d < minDist) { minDist = d; closestEnemy = target; }
                }
            });

            // 2. ì´ë™ ë˜ëŠ” ê³µê²©
            let distToBase = Math.abs(u.x - enemyBaseX);
            
            if (minDist <= u.range) {
                // ì  ìœ ë‹› ê³µê²©
                closestEnemy.hp -= u.damage / 60; 
                // ê³µê²© ì´í™íŠ¸ (ì„ )
                ctx.strokeStyle = u.side === 'left' ? '#60a5fa' : '#f87171';
                ctx.beginPath(); ctx.moveTo(u.x, u.y); ctx.lineTo(closestEnemy.x, closestEnemy.y); ctx.stroke();
            } else if (distToBase <= u.range) {
                // ì„± ê³µê²©
                baseHp[targetSide] -= u.damage / 60;
                ctx.strokeStyle = 'yellow';
                ctx.beginPath(); ctx.moveTo(u.x, u.y); ctx.lineTo(enemyBaseX, canvas.height/2); ctx.stroke();
            } else {
                // ì „ì§„
                u.x += u.side === 'left' ? u.speed : -u.speed;
            }

            // 3. ìœ ë‹› ê·¸ë¦¬ê¸°
            drawUnit(u);
        });

        // ì£½ì€ ìœ ë‹› ì œê±°
        units = units.filter(u => u.hp > 0);

        // ìŠ¹íŒ¨ ì²´í¬
        if (baseHp.left <= 0) showResult("RIGHT PLAYER WIN!");
        if (baseHp.right <= 0) showResult("LEFT PLAYER WIN!");

        updateUI();
        requestAnimationFrame(gameLoop);
    }

    function drawBase(x, y, side, hp) {
        ctx.fillStyle = side === 'left' ? '#3b82f6' : '#ef4444';
        ctx.fillRect(x - 40, y - 60, 80, 120);
        ctx.fillStyle = 'white';
        ctx.textAlign = 'center';
        ctx.fillText(`CASTLE`, x, y);
        // HP ë°”
        ctx.fillStyle = '#1e293b'; ctx.fillRect(x - 40, y - 80, 80, 10);
        ctx.fillStyle = '#10b981'; ctx.fillRect(x - 40, y - 80, (hp / 100) * 80, 10);
    }

    function drawUnit(u) {
        ctx.font = "24px Arial";
        ctx.textAlign = "center";
        ctx.fillText(u.icon, u.x, u.y);
        // ìœ ë‹› HP ë°”
        ctx.fillStyle = 'red'; ctx.fillRect(u.x - 15, u.y - 25, 30, 4);
        ctx.fillStyle = 'lime'; ctx.fillRect(u.x - 15, u.y - 25, (u.hp / u.maxHp) * 30, 4);
    }

    function updateUI() {
        document.getElementById('gold').innerText = Math.floor(gold);
        document.getElementById('core-hp').innerText = `${Math.ceil(baseHp.right)} / 100`;
        // ë‚´ ì„± HP í‘œì‹œëŠ” ì•Œì•„ì„œ ë˜ë„ë¡ ì„¤ì •
    }

    function showResult(text) {
        document.getElementById('overlay').style.display = 'flex';
        document.getElementById('result-text').innerText = text;
    }

    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.onresize = resize;
    init();
</script>
</body>
</html>
