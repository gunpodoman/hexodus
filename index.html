<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>HEXODUS - The Great Migration</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { margin: 0; background: #020617; color: white; font-family: sans-serif; overflow: hidden; }
        #ui { position: absolute; top: 20px; left: 20px; z-index: 10; pointer-events: none; }
        .stats-card { background: rgba(15, 23, 42, 0.9); padding: 20px; border-radius: 16px; pointer-events: auto; border: 1px solid rgba(255,255,255,0.1); }
        canvas { display: block; cursor: crosshair; }
        #status-msg { position: fixed; bottom: 20px; width: 100%; text-align: center; color: #475569; }
    </style>
</head>
<body>

<div id="ui">
    <div class="stats-card">
        <div id="p-nickname" style="font-weight:bold; font-size:1.2rem; margin-bottom:5px;">연결 중...</div>
        <div style="font-size:0.9rem; color:#94a3b8;">AP: <b id="p-ap" style="color:white">0</b> | Gold: <b id="p-gold" style="color:white">0</b></div>
    </div>
</div>
<div id="status-msg">동기화 대기 중...</div>
<canvas id="mapCanvas"></canvas>

<script>
    // --- 설정 정보 ---
    const SUPABASE_URL = 'https://ypwfazsbnudddksqkkiz.supabase.co/';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlwd2ZhenNibnVkZGRrc3Fra2l6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY5ODg4NTgsImV4cCI6MjA4MjU2NDg1OH0.Mz0jdNuLughgNtklbuBeh5K2Q4HQf2cKt6dmeqBSJy4';
    const sClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const canvas = document.getElementById('mapCanvas');
    const ctx = canvas.getContext('2d');
    const hexSize = 45;
    
    let myInfo = null;
    let worldMap = [];
    let playersCache = {};

    async function init() {
        resize();
        window.addEventListener('resize', resize);
        
        try {
            // 1. 익명 로그인 (Authentication -> Providers -> Anonymous 활성화 필수!)
            const { data: { user }, error: authError } = await sClient.auth.signInAnonymously();
            if (authError) throw new Error("로그인 실패: " + authError.message);

            const myColor = `hsl(${Math.random() * 360}, 75%, 60%)`;
            
            // 2. 플레이어 등록
            const { data: pData, error: pError } = await sClient.from('players').upsert({
                id: user.id, nickname: "CONQUEROR_" + user.id.slice(0,4), color: myColor
            }).select().single();
            if (pError) throw new Error("플레이어 등록 실패: " + pError.message);

            myInfo = pData;
            updateUI();

            // 3. 맵 데이터 로드
            const { data: mapData, error: mError } = await sClient.from('world_map').select('*');
            if (mError) throw new Error("맵 로드 실패: " + mError.message);
            if (!mapData || mapData.length === 0) throw new Error("맵 데이터가 비어있습니다. SQL Editor에서 데이터를 먼저 생성하세요!");

            worldMap = mapData;

            // 4. 실시간 구독
            sClient.channel('world-changes')
                .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'world_map' }, payload => {
                    const idx = worldMap.findIndex(t => t.id === payload.new.id);
                    if (idx !== -1) worldMap[idx] = payload.new;
                    render();
                }).subscribe();

            render();
            document.getElementById('status-msg').innerText = "WORLD SYNCED";
        } catch (err) {
            alert(err.message);
        }
    }

    // (좌표 계산 및 렌더링 함수들 - 이전과 동일)
    function getCanvasCoords(q, r) {
        const x = canvas.width / 2 + hexSize * (3/2 * q);
        const y = canvas.height / 2 + hexSize * (Math.sqrt(3)/2 * q + Math.sqrt(3) * r);
        return { x, y };
    }

    function drawHex(tile) {
        const { x, y } = getCanvasCoords(tile.q, tile.r);
        ctx.beginPath();
        for (let i = 0; i < 6; i++) {
            const angle = i * Math.PI / 3;
            ctx.lineTo(x + hexSize * Math.cos(angle), y + hexSize * Math.sin(angle));
        }
        ctx.closePath();
        ctx.fillStyle = tile.tile_type === 'mountain' ? '#1e293b' : '#0f172a';
        ctx.fill();
        if (tile.owner_id) {
            ctx.strokeStyle = (tile.owner_id === myInfo.id) ? myInfo.color : '#ef4444';
            ctx.lineWidth = 3; ctx.stroke();
        } else {
            ctx.strokeStyle = 'rgba(255,255,255,0.1)'; ctx.lineWidth = 1; ctx.stroke();
        }
    }

    function render() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        worldMap.forEach(drawHex);
    }

    canvas.onclick = async (e) => {
        const rect = canvas.getBoundingClientRect();
        const mx = e.clientX - rect.left - canvas.width/2;
        const my = e.clientY - rect.top - canvas.height/2;
        const q = Math.round(2/3 * mx / hexSize);
        const r = Math.round((-1/3 * mx + Math.sqrt(3)/3 * my) / hexSize);
        const target = worldMap.find(t => t.q === q && t.r === r);
        if (target && !target.owner_id && myInfo.ap > 0) {
            await sClient.from('world_map').update({ owner_id: myInfo.id }).eq('id', target.id);
            myInfo.ap--; updateUI();
        }
    };

    function updateUI() {
        document.getElementById('p-nickname').innerText = myInfo.nickname;
        document.getElementById('p-nickname').style.color = myInfo.color;
        document.getElementById('p-ap').innerText = myInfo.ap;
        document.getElementById('p-gold').innerText = myInfo.gold;
    }

    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; render(); }

    init();
</script>
</body>
</html>
