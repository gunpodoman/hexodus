<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>HEXODUS: The Strategy</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --panel: rgba(13, 17, 23, 0.95); --accent: #00f2ff; }
        body { margin: 0; background: #05070a; color: white; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        
        /* UI 디자인 개선 */
        #top-gui { position: absolute; top: 20px; left: 20px; right: 20px; display: flex; justify-content: space-between; pointer-events: none; }
        .stat-box { background: var(--panel); padding: 15px 25px; border-radius: 12px; border: 1px solid #30363d; pointer-events: auto; min-width: 200px; box-shadow: 0 8px 32px rgba(0,0,0,0.5); }
        .nick { font-size: 1.2rem; font-weight: 900; margin-bottom: 8px; text-shadow: 0 0 10px var(--color); }
        .bar-bg { background: #21262d; height: 6px; border-radius: 3px; margin: 10px 0; overflow: hidden; }
        .bar-fill { background: var(--accent); height: 100%; transition: width 0.3s ease; }
        
        #status-msg { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); font-size: 0.8rem; letter-spacing: 2px; color: #8b949e; text-transform: uppercase; }
        canvas { display: block; }
    </style>
</head>
<body>

<div id="top-gui">
    <div class="stat-box">
        <div id="p-nick" class="nick" style="--color: #fff">CONNECTING...</div>
        <div style="font-size: 0.8rem; color: #8b949e;">ACTION POINTS (AP)</div>
        <div class="bar-bg"><div id="ap-bar" class="bar-fill" style="width: 0%"></div></div>
        <div style="display: flex; justify-content: space-between; font-size: 0.9rem;">
            <span>Gold: <b id="p-gold" style="color:#e3b341">0</b></span>
            <span>Tiles: <b id="p-tiles">0</b></span>
        </div>
    </div>
    
    <div class="stat-box" style="min-width: 100px; text-align: center;">
        <div style="font-size: 0.7rem; color: #8b949e;">REVENUE</div>
        <div style="font-size: 1.1rem; color: #3fb950; font-weight: bold;">+<span id="p-income">0</span> / sec</div>
    </div>
</div>

<div id="status-msg">INITIALIZING SYSTEM...</div>
<canvas id="mapCanvas"></canvas>

<script>
    const SUPABASE_URL = 'https://ypwfazsbnudddksqkkiz.supabase.co/';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlwd2ZhenNibnVkZGRrc3Fra2l6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY5ODg4NTgsImV4cCI6MjA4MjU2NDg1OH0.Mz0jdNuLughgNtklbuBeh5K2Q4HQf2cKt6dmeqBSJy4';
    const sClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const canvas = document.getElementById('mapCanvas');
    const ctx = canvas.getContext('2d');
    let hexSize = 50;
    
    let myInfo = null;
    let worldMap = [];
    let playersCache = {};

    async function init() {
        resize();
        window.addEventListener('resize', resize);
        
        try {
            const { data: { user } } = await sClient.auth.signInAnonymously();
            
            // 1. 유저 정보 불러오기 또는 생성
            const { data: pData } = await sClient.from('players').upsert({
                id: user.id, 
                nickname: "CONQUEROR_" + user.id.slice(0,4), 
                color: `hsl(${Math.random() * 360}, 80%, 60%)`,
                ap: 10, gold: 100
            }).select().single();

            myInfo = pData;

            // 2. 전체 데이터 로드
            const [mapRes, playerRes] = await Promise.all([
                sClient.from('world_map').select('*'),
                sClient.from('players').select('id, color, nickname')
            ]);
            
            worldMap = mapRes.data;
            playerRes.data.forEach(p => playersCache[p.id] = p);

            // 3. 실시간 동기화
            sClient.channel('room1')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'world_map' }, payload => {
                    const idx = worldMap.findIndex(t => t.id === payload.new.id);
                    if (idx !== -1) worldMap[idx] = payload.new;
                    render();
                })
                .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'players' }, payload => {
                    if (payload.new.id === myInfo.id) {
                        myInfo.ap = payload.new.ap;
                        myInfo.gold = payload.new.gold;
                        updateUI();
                    }
                    playersCache[payload.new.id] = payload.new;
                })
                .subscribe();

            // 4. 게임 루프 시작 (AP/자원 자동 생성)
            startGameLoop();
            render();
            document.getElementById('status-msg').innerText = "SYSTEM ONLINE";
        } catch (e) { alert(e.message); }
    }

    function startGameLoop() {
        setInterval(async () => {
            // 자원 생산 로직: 땅 1개당 1골드씩 매초 상승 (로컬 표시용)
            const myTiles = worldMap.filter(t => t.owner_id === myInfo.id).length;
            myInfo.gold += myTiles;
            
            // AP 회복 로직 (최대 20까지)
            if (myInfo.ap < 20) myInfo.ap += 0.2; 
            
            updateUI();
        }, 1000);

        // 10초마다 DB에 내 상태 저장
        setInterval(() => {
            sClient.from('players').update({ ap: Math.floor(myInfo.ap), gold: myInfo.gold }).eq('id', myInfo.id).then();
        }, 10000);
    }

    function getDistance(q1, r1, q2, r2) {
        return (Math.abs(q1 - q2) + Math.abs(q1 + r1 - q2 - r2) + Math.abs(r1 - r2)) / 2;
    }

    canvas.onclick = async (e) => {
        const rect = canvas.getBoundingClientRect();
        const mx = e.clientX - rect.left - canvas.width/2;
        const my = e.clientY - rect.top - canvas.height/2;
        const q = Math.round(2/3 * mx / hexSize);
        const r = Math.round((-1/3 * mx + Math.sqrt(3)/3 * my) / hexSize);

        const target = worldMap.find(t => t.q === q && t.r === r);
        if (!target || target.owner_id) return;

        // 확장 규칙: 내 땅이 하나도 없으면 아무데나 가능, 있으면 인접한 곳만 가능
        const myTiles = worldMap.filter(t => t.owner_id === myInfo.id);
        const canCapture = myTiles.length === 0 || myTiles.some(t => getDistance(t.q, t.r, q, r) === 1);

        if (canCapture && myInfo.ap >= 1) {
            myInfo.ap -= 1;
            // 즉시 반영(클라이언트 사이드 예측)
            target.owner_id = myInfo.id;
            render(); updateUI();
            
            // DB 업데이트
            await sClient.from('world_map').update({ owner_id: myInfo.id }).eq('id', target.id);
            await sClient.from('players').update({ ap: Math.floor(myInfo.ap) }).eq('id', myInfo.id);
        } else if (!canCapture) {
            document.getElementById('status-msg').innerText = "TOO FAR TO EXPAND!";
            setTimeout(() => document.getElementById('status-msg').innerText = "SYSTEM ONLINE", 2000);
        }
    };

    function drawHex(tile) {
        const { x, y } = getCanvasCoords(tile.q, tile.r);
        ctx.beginPath();
        for (let i = 0; i < 6; i++) {
            const angle = i * Math.PI / 3;
            ctx.lineTo(x + hexSize * Math.cos(angle), y + hexSize * Math.sin(angle));
        }
        ctx.closePath();

        const owner = playersCache[tile.owner_id];
        ctx.fillStyle = owner ? owner.color + '44' : (tile.tile_type === 'mountain' ? '#161b22' : '#0d1117');
        ctx.fill();
        
        ctx.strokeStyle = owner ? owner.color : '#30363d';
        ctx.lineWidth = owner ? 3 : 1;
        ctx.stroke();

        if (owner) { // 점령된 타일 효과
            ctx.shadowBlur = 10; ctx.shadowColor = owner.color;
            ctx.stroke(); ctx.shadowBlur = 0;
        }
    }

    function getCanvasCoords(q, r) {
        return { x: canvas.width / 2 + hexSize * (3/2 * q), y: canvas.height / 2 + hexSize * (Math.sqrt(3)/2 * q + Math.sqrt(3) * r) };
    }

    function render() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        worldMap.forEach(drawHex);
    }

    function updateUI() {
        const myTiles = worldMap.filter(t => t.owner_id === myInfo.id).length;
        document.getElementById('p-nick').innerText = myInfo.nickname;
        document.getElementById('p-nick').style.setProperty('--color', myInfo.color);
        document.getElementById('p-gold').innerText = Math.floor(myInfo.gold);
        document.getElementById('p-tiles').innerText = myTiles;
        document.getElementById('p-income').innerText = myTiles;
        document.getElementById('ap-bar').style.width = (myInfo.ap / 20 * 100) + "%";
    }

    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; if(worldMap.length) render(); }
    init();
</script>
</body>
</html>
