<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>HEXODUS: THE SIEGE</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --def: #3498db; --atk: #e74c3c; --bg: #0f172a; }
        body { margin: 0; background: var(--bg); color: white; font-family: 'Pretendard', sans-serif; overflow: hidden; }
        
        /* ë¡œë¹„ ìŠ¤íƒ€ì¼ */
        #lobby { position: fixed; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(15, 23, 42, 0.95); z-index: 100; }
        .room-card { background: #1e293b; padding: 20px; margin: 10px; width: 300px; border-radius: 8px; border: 1px solid #334155; display: flex; justify-content: space-between; align-items: center; }
        
        /* ê²Œì„ UI ìŠ¤íƒ€ì¼ */
        #game-ui { position: absolute; top: 0; left: 0; right: 0; padding: 20px; display: none; justify-content: space-between; pointer-events: none; }
        .stat-box { background: rgba(0,0,0,0.7); padding: 15px; border-radius: 10px; border: 2px solid #333; pointer-events: auto; }
        #controls { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); display: none; gap: 10px; }
        .btn { background: #1e293b; border: 2px solid #475569; color: white; padding: 12px 24px; cursor: pointer; border-radius: 5px; font-weight: bold; }
        .btn:hover { background: #334155; }
        .btn.active { border-color: #38bdf8; box-shadow: 0 0 15px #38bdf8; }
        
        canvas { display: block; background: #020617; }
        #overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 50; }
    </style>
</head>
<body>

<div id="lobby">
    <h1>HEXODUS: THE SIEGE</h1>
    <button class="btn" onclick="createRoom()" style="margin-bottom: 30px; background: #38bdf8;">+ ìƒˆ ì „íˆ¬ ë°© ë§Œë“¤ê¸°</button>
    <div id="room-list">ë°© ëª©ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
</div>

<div id="game-ui">
    <div class="stat-box" id="my-stats">
        <div id="role-tag" style="font-size: 1.2em; font-weight: bold; margin-bottom: 5px;">ì—­í•  í™•ì¸ ì¤‘...</div>
        <div>GOLD: <span id="gold">0</span>G (+5/sec)</div>
    </div>
    <div class="stat-box" style="text-align: right;">
        <div style="color: #94a3b8;">CORE HP</div>
        <div id="core-hp" style="font-size: 1.5em; color: #ff4757;">1000 / 1000</div>
    </div>
</div>

<div id="controls">
    </div>

<div id="overlay">
    <h2 id="result-msg">ìŠ¹ë¦¬!</h2>
    <button class="btn" onclick="location.reload()">ë¡œë¹„ë¡œ ëŒì•„ê°€ê¸°</button>
</div>

<canvas id="gameCanvas"></canvas>

<script>
    const SUPABASE_URL = 'https://ypwfazsbnudddksqkkiz.supabase.co/';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlwd2ZhenNibnVkZGRrc3Fra2l6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY5ODg4NTgsImV4cCI6MjA4MjU2NDg1OH0.Mz0jdNuLughgNtklbuBeh5K2Q4HQf2cKt6dmeqBSJy4';
    const sClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let myId, currentRoomId, myRole; // 'defender' or 'attacker'
    let gold = 0;
    let coreHp = 1000;
    let gameLoop;
    let buildings = []; // {x, y, type}
    let units = []; // {x, y, hp, type}
    
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    async function init() {
        const { data: { user } } = await sClient.auth.signInAnonymously();
        myId = user.id;
        refreshRooms();
        
        // ì‹¤ì‹œê°„ ë°© ëª©ë¡ ì—…ë°ì´íŠ¸
        sClient.channel('lobby').on('postgres_changes', { event: '*', schema: 'public', table: 'rooms' }, refreshRooms).subscribe();
    }

    async function refreshRooms() {
        const { data } = await sClient.from('rooms').select('*').eq('status', 'waiting').order('created_at', { ascending: false });
        const list = document.getElementById('room-list');
        list.innerHTML = data.length ? '' : 'í˜„ì¬ ì—´ë ¤ìˆëŠ” ë°©ì´ ì—†ìŠµë‹ˆë‹¤.';
        data.forEach(room => {
            list.innerHTML += `
                <div class="room-card">
                    <span>${room.name}</span>
                    <button class="btn" onclick="joinRoom('${room.id}')">ì°¸ê°€í•˜ê¸°</button>
                </div>`;
        });
    }

    async function createRoom() {
        const name = `ì „íˆ¬ #${Math.floor(Math.random() * 1000)}`;
        const { data, error } = await sClient.from('rooms').insert([{ name, defender_id: myId, status: 'waiting' }]).select();
        if (data) joinRoom(data[0].id);
    }

    async function joinRoom(roomId) {
        currentRoomId = roomId;
        const { data: room } = await sClient.from('rooms').select('*').eq('id', roomId).single();
        
        if (room.defender_id === myId) {
            myRole = 'defender';
        } else {
            myRole = 'attacker';
            await sClient.from('rooms').update({ attacker_id: myId, status: 'playing' }).eq('id', roomId);
        }

        startMatch();
    }

    function startMatch() {
        document.getElementById('lobby').style.display = 'none';
        document.getElementById('game-ui').style.display = 'flex';
        document.getElementById('controls').style.display = 'flex';
        
        const roleTag = document.getElementById('role-tag');
        const ctrl = document.getElementById('controls');
        
        if (myRole === 'defender') {
            roleTag.innerText = "ğŸ›¡ï¸ ë§‰ëŠ” ì (DEFENDER)";
            roleTag.style.color = "#38bdf8";
            ctrl.innerHTML = `
                <button class="btn" onclick="setAction('wall')">ğŸ§± ë°©ë²½ (20G)</button>
                <button class="btn" onclick="setAction('tower')">ğŸ¹ í¬íƒ‘ (50G)</button>
            `;
        } else {
            roleTag.innerText = "âš”ï¸ ëš«ëŠ” ì (ATTACKER)";
            roleTag.style.color = "#fb7185";
            ctrl.innerHTML = `
                <button class="btn" onclick="setAction('scout')">ğŸƒ ì •ì°°ë³‘ (30G)</button>
                <button class="btn" onclick="setAction('tank')">ğŸ›¡ï¸ ê±°ì¸ (80G)</button>
            `;
        }

        // ì‹¤ì‹œê°„ ì•¡ì…˜ ìˆ˜ì‹ 
        sClient.channel(`room_${currentRoomId}`)
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'game_actions', filter: `room_id=eq.${currentRoomId}` }, payload => {
                handleAction(payload.new);
            }).subscribe();

        // 1ì´ˆë§ˆë‹¤ ìì› ìƒì‚° ë° ê²Œì„ ë£¨í”„ ì‹œì‘
        setInterval(() => { gold += 5; updateUI(); }, 1000);
        resize();
        requestAnimationFrame(update);
    }

    let selectedType = null;
    function setAction(type) {
        selectedType = type;
        document.querySelectorAll('.btn').forEach(b => b.classList.toggle('active', b.innerText.includes(type)));
    }

    canvas.onclick = async (e) => {
        if (!selectedType) return;
        
        const cost = { wall: 20, tower: 50, scout: 30, tank: 80 }[selectedType];
        if (gold < cost) return;

        gold -= cost;
        await sClient.from('game_actions').insert([{
            room_id: currentRoomId,
            player_id: myId,
            action_type: myRole === 'defender' ? 'build' : 'spawn',
            data: { x: e.clientX, y: e.clientY, type: selectedType }
        }]);
    }

    function handleAction(action) {
        if (action.action_type === 'build') {
            buildings.push({ ...action.data, hp: action.data.type === 'wall' ? 200 : 100 });
        } else {
            // ê³µê²©ìëŠ” ìš°ì¸¡ì—ì„œ ì†Œí™˜
            units.push({ 
                x: canvas.width, 
                y: action.data.y, 
                type: action.data.type, 
                hp: action.data.type === 'scout' ? 50 : 200,
                speed: action.data.type === 'scout' ? 2 : 0.8
            });
        }
    }

    function update() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // 1. ë³¸ì§„(Core) ê·¸ë¦¬ê¸°
        ctx.fillStyle = '#1e293b';
        ctx.fillRect(0, 0, 100, canvas.height);
        ctx.fillStyle = '#38bdf8';
        ctx.textAlign = 'center';
        ctx.fillText("CORE", 50, canvas.height/2);

        // 2. ê±´ë¬¼ ì—…ë°ì´íŠ¸ ë° ê·¸ë¦¬ê¸°
        buildings.forEach((b, i) => {
            ctx.fillStyle = b.type === 'wall' ? '#475569' : '#0ea5e9';
            ctx.fillRect(b.x - 20, b.y - 20, 40, 40);
            ctx.fillStyle = 'white';
            ctx.fillText(b.hp, b.x, b.y - 25);

            // í¬íƒ‘ ì‚¬ê²© ë¡œì§ (ê°€ì¥ ê°€ê¹Œìš´ ìœ ë‹› ê³µê²©)
            if (b.type === 'tower') {
                units.forEach(u => {
                    const dist = Math.hypot(u.x - b.x, u.y - b.y);
                    if (dist < 200) {
                        u.hp -= 0.5; // ì‹¤ì‹œê°„ ë°ë¯¸ì§€
                        ctx.strokeStyle = '#0ea5e9';
                        ctx.beginPath(); ctx.moveTo(b.x, b.y); ctx.lineTo(u.x, u.y); ctx.stroke();
                    }
                });
            }
        });

        // 3. ìœ ë‹› ì—…ë°ì´íŠ¸ ë° ê·¸ë¦¬ê¸°
        units.forEach((u, i) => {
            u.x -= u.speed; // ì™¼ìª½ìœ¼ë¡œ ì „ì§„
            
            ctx.fillStyle = u.type === 'scout' ? '#fb7185' : '#e11d48';
            ctx.beginPath(); ctx.arc(u.x, u.y, u.type === 'scout' ? 10 : 20, 0, Math.PI*2); ctx.fill();
            
            // ê±´ë¬¼ ì¶©ëŒ ì²´í¬
            buildings.forEach(b => {
                if (Math.hypot(u.x - b.x, u.y - b.y) < 30) {
                    b.hp -= 1;
                    u.x += u.speed; // ì „ì§„ ì •ì§€
                }
            });

            // ì½”ì–´ ë„ë‹¬ ì²´í¬
            if (u.x < 100) {
                coreHp -= (u.type === 'scout' ? 10 : 50);
                units.splice(i, 1);
                updateUI();
            }

            // ì‚¬ë§ ì²´í¬
            if (u.hp <= 0) units.splice(i, 1);
        });

        // ê±´ë¬¼ íŒŒê´´ ì²´í¬
        buildings = buildings.filter(b => b.hp > 0);

        if (coreHp <= 0) endGame("ê³µê²©ì ìŠ¹ë¦¬!");

        requestAnimationFrame(update);
    }

    function updateUI() {
        document.getElementById('gold').innerText = gold;
        document.getElementById('core-hp').innerText = `${coreHp} / 1000`;
    }

    function endGame(msg) {
        document.getElementById('overlay').style.display = 'flex';
        document.getElementById('result-msg').innerText = msg;
    }

    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.onresize = resize;
    init();
</script>
</body>
</html>
