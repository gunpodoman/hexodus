<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>HEXODUS: THE FINAL</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --p1: #3b82f6; --p2: #ef4444; --bg: #0f172a; }
        body { margin: 0; background: var(--bg); color: white; font-family: sans-serif; overflow: hidden; }
        
        /* ë¡œë¹„ ë ˆì´ì–´ */
        #lobby { position: fixed; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #020617; z-index: 100; }
        .btn { background: #1e293b; border: 1px solid #334155; color: white; padding: 15px 30px; cursor: pointer; border-radius: 8px; font-weight: bold; margin: 10px; }
        .btn:hover { background: #334155; }
        .room-item { background: #1e293b; padding: 15px; margin: 5px; width: 300px; display: flex; justify-content: space-between; border-radius: 8px; }

        /* ê²Œì„ í™”ë©´ */
        #ui { position: absolute; top: 0; width: 100%; padding: 20px; display: none; justify-content: space-between; box-sizing: border-box; }
        .stat { background: rgba(0,0,0,0.7); padding: 15px; border-radius: 10px; border: 2px solid #333; }
        #bottom-menu { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); display: none; gap: 10px; }
        
        canvas { display: block; }
        #debug { position: fixed; bottom: 0; left: 0; background: rgba(0,0,0,0.8); color: lime; font-size: 12px; max-height: 100px; overflow-y: auto; width: 100%; pointer-events: none; }
    </style>
</head>
<body>

<div id="lobby">
    <h1>HEXODUS: 1vs1 ì „ëµ</h1>
    <button class="btn" onclick="createRoom()" style="background: var(--p1);">ìƒˆ ë°© ë§Œë“¤ê¸°</button>
    <div id="room-list">ë°© ëª©ë¡ ë¡œë”© ì¤‘...</div>
</div>

<div id="ui">
    <div class="stat" style="border-left: 5px solid var(--p1);">
        <div>MY GOLD: <span id="gold-val" style="color: gold;">0</span>G</div>
        <div id="my-side-text">SIDE: -</div>
    </div>
    <div class="stat" style="text-align: right; border-right: 5px solid var(--p2);">
        <div>CORE HP</div>
        <div id="hp-val" style="font-size: 20px; color: #ff4757;">100 / 100</div>
    </div>
</div>

<div id="bottom-menu">
    <button class="btn" onclick="sendSpawn('sword')">âš”ï¸ ê²€ë³‘ (20G)</button>
    <button class="btn" onclick="sendSpawn('shield')">ğŸ›¡ï¸ ë°©íŒ¨ë³‘ (50G)</button>
    <button class="btn" onclick="sendSpawn('archer')">ğŸ¹ ê¶ìˆ˜ (40G)</button>
</div>

<div id="debug">ì‹œìŠ¤í…œ ë¡œê·¸ ëŒ€ê¸° ì¤‘...</div>
<canvas id="gameCanvas"></canvas>

<script>
    const SUPABASE_URL = 'https://ypwfazsbnudddksqkkiz.supabase.co/';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlwd2ZhenNibnVkZGRrc3Fra2l6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY5ODg4NTgsImV4cCI6MjA4MjU2NDg1OH0.Mz0jdNuLughgNtklbuBeh5K2Q4HQf2cKt6dmeqBSJy4';
    const sClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let myId = "user_" + Math.random().toString(36).slice(2, 7);
    let myRoomId = null;
    let mySide = null;
    let gold = 0;
    let baseHp = { left: 100, right: 100 };
    let units = [];
    
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    function log(msg) {
        const d = document.getElementById('debug');
        d.innerHTML += `<div>> ${msg}</div>`;
        d.scrollTop = d.scrollHeight;
    }

    async function init() {
        log("ì ‘ì† ì‹œë„ ì¤‘...");
        refreshRooms();
        sClient.channel('lobby').on('postgres_changes', { event: '*', schema: 'public', table: 'rooms' }, refreshRooms).subscribe();
    }

    async function refreshRooms() {
        const { data, error } = await sClient.from('rooms').select('*').eq('status', 'WAITING');
        if (error) return log("ë°© ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: " + error.message);
        
        const list = document.getElementById('room-list');
        list.innerHTML = data.length === 0 ? "ëŒ€ê¸° ì¤‘ì¸ ë°©ì´ ì—†ìŠµë‹ˆë‹¤." : "";
        data.forEach(room => {
            const item = document.createElement('div');
            item.className = 'room-item';
            item.innerHTML = `<span>ë°© #${room.id.slice(0,4)}</span> <button class="btn" style="margin:0; padding:5px 10px;" onclick="joinRoom('${room.id}')">ì°¸ê°€</button>`;
            list.appendChild(item);
        });
    }

    async function createRoom() {
        log("ë°© ìƒì„± ì¤‘...");
        const { data, error } = await sClient.from('rooms').insert([{ p1_id: myId, status: 'WAITING' }]).select().single();
        
        if (error) {
            log("ë°© ìƒì„± ì‹¤íŒ¨: " + error.message);
            alert("SQLì—ì„œ RLSë¥¼ ê»ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”!");
            return;
        }

        myRoomId = data.id;
        mySide = 'left';
        log("ë°© ìƒì„± ì„±ê³µ! ìƒëŒ€ë°© ëŒ€ê¸° ì¤‘...");
        document.getElementById('lobby').innerHTML = `<h1>ìƒëŒ€ë°© ëŒ€ê¸° ì¤‘...</h1><p>ë°© ID: ${myRoomId.slice(0,4)}</p><button class="btn" onclick="location.reload()">ì·¨ì†Œ</button>`;

        // ìƒëŒ€ë°© ì°¸ê°€ ê°ì‹œ
        sClient.channel(`room_${myRoomId}`)
            .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'rooms', filter: `id=eq.${myRoomId}` }, payload => {
                if (payload.new.status === 'PLAYING') startGame();
            }).subscribe();
    }

    async function joinRoom(roomId) {
        log("ë°© ì°¸ê°€ ì¤‘...");
        const { error } = await sClient.from('rooms').update({ p2_id: myId, status: 'PLAYING' }).eq('id', roomId);
        
        if (error) return log("ì°¸ê°€ ì‹¤íŒ¨: " + error.message);
        
        myRoomId = roomId;
        mySide = 'right';
        startGame();
    }

    function startGame() {
        log("ê²Œì„ ì‹œì‘!");
        document.getElementById('lobby').style.display = 'none';
        document.getElementById('ui').style.display = 'flex';
        document.getElementById('bottom-menu').style.display = 'flex';
        document.getElementById('my-side-text').innerText = "SIDE: " + mySide.toUpperCase();
        
        // ì´ë²¤íŠ¸ êµ¬ë…
        sClient.channel(`events_${myRoomId}`)
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'game_events', filter: `room_id=eq.${myRoomId}` }, payload => {
                spawnUnit(payload.new.side, payload.new.unit_type);
            }).subscribe();

        setInterval(() => { gold += 10; updateUI(); }, 1000);
        resize();
        requestAnimationFrame(update);
    }

    async function sendSpawn(type) {
        const costs = { sword: 20, shield: 50, archer: 40 };
        if (gold < costs[type]) return;
        
        gold -= costs[type];
        const { error } = await sClient.from('game_events').insert([{ room_id: myRoomId, side: mySide, unit_type: type }]);
        if (error) log("ìœ ë‹› ì†Œí™˜ ì‹¤íŒ¨: " + error.message);
    }

    function spawnUnit(side, type) {
        const stats = {
            sword: { hp: 100, speed: 2, range: 40, atk: 10, icon: 'âš”ï¸' },
            shield: { hp: 300, speed: 1, range: 30, atk: 5, icon: 'ğŸ›¡ï¸' },
            archer: { hp: 60, speed: 1.5, range: 200, atk: 15, icon: 'ğŸ¹' }
        }[type];

        units.push({
            side, type, ...stats,
            maxHp: stats.hp,
            x: side === 'left' ? 100 : canvas.width - 100,
            y: canvas.height / 2 + (Math.random() * 40 - 20),
            lastAtk: 0
        });
    }

    function update(time) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // ì„± ê·¸ë¦¬ê¸°
        drawBase(60, canvas.height/2, 'left', baseHp.left);
        drawBase(canvas.width - 60, canvas.height/2, 'right', baseHp.right);

        units.forEach(u => {
            const enemySide = u.side === 'left' ? 'right' : 'left';
            const enemyBaseX = u.side === 'left' ? canvas.width - 60 : 60;
            
            // ê°€ì¥ ê°€ê¹Œìš´ ì  ì°¾ê¸°
            let target = null;
            let minDist = Infinity;
            units.forEach(e => {
                if (e.side !== u.side) {
                    let d = Math.abs(u.x - e.x);
                    if (d < minDist) { minDist = d; target = e; }
                }
            });

            // ì „íˆ¬ ë¡œì§
            if (minDist <= u.range) {
                if (time - u.lastAtk > 1000) { target.hp -= u.atk; u.lastAtk = time; }
            } else if (Math.abs(u.x - enemyBaseX) <= u.range) {
                if (time - u.lastAtk > 1000) { baseHp[enemySide] -= u.atk; u.lastAtk = time; }
            } else {
                u.x += u.side === 'left' ? u.speed : -u.speed;
            }

            // ê·¸ë¦¬ê¸°
            ctx.font = "24px Arial";
            ctx.fillText(u.icon, u.x, u.y);
            ctx.fillStyle = 'red'; ctx.fillRect(u.x - 15, u.y - 30, 30, 4);
            ctx.fillStyle = 'lime'; ctx.fillRect(u.x - 15, u.y - 30, (u.hp/u.maxHp)*30, 4);
        });

        units = units.filter(u => u.hp > 0);
        if (baseHp.left <= 0 || baseHp.right <= 0) {
            alert(baseHp.left <= 0 ? "RED WIN!" : "BLUE WIN!");
            location.reload();
            return;
        }

        updateUI();
        requestAnimationFrame(update);
    }

    function drawBase(x, y, side, hp) {
        ctx.fillStyle = side === 'left' ? varColor('--p1') : varColor('--p2');
        ctx.fillRect(x-40, y-60, 80, 120);
        ctx.fillStyle = 'white'; ctx.fillText("BASE", x-25, y);
        ctx.fillStyle = 'gray'; ctx.fillRect(x-40, y-80, 80, 10);
        ctx.fillStyle = 'lime'; ctx.fillRect(x-40, y-80, hp * 0.8, 10);
    }

    function updateUI() {
        document.getElementById('gold-val').innerText = gold;
        document.getElementById('hp-val').innerText = `${Math.ceil(baseHp.right)} / 100`;
    }

    function varColor(name) { return getComputedStyle(document.documentElement).getPropertyValue(name); }
    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    init();
</script>
</body>
</html>
